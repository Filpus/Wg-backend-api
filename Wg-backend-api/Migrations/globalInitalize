CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);

START TRANSACTION;

DO $EF$
BEGIN
        IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'Global') THEN
            CREATE SCHEMA "Global";
        END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE TABLE "Global".users (
        id integer GENERATED BY DEFAULT AS IDENTITY,
        name text NOT NULL,
        email text NOT NULL,
        password text NOT NULL,
        isarchived boolean NOT NULL,
        CONSTRAINT "PK_users" PRIMARY KEY (id)
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE TABLE "Global".games (
        id integer GENERATED BY DEFAULT AS IDENTITY,
        name text NOT NULL,
        description text,
        image text,
        "ownerId" integer NOT NULL,
        CONSTRAINT "PK_games" PRIMARY KEY (id),
        CONSTRAINT "FK_games_users_ownerId" FOREIGN KEY ("ownerId") REFERENCES "Global".users (id) ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE TABLE "Global".gameaccess (
        id integer GENERATED BY DEFAULT AS IDENTITY,
        "fk_Users" integer NOT NULL,
        "fk_Games" integer NOT NULL,
        "accessType" integer NOT NULL,
        "isArchived" boolean NOT NULL,
        CONSTRAINT "PK_gameaccess" PRIMARY KEY ("fk_Users", "fk_Games"),
        CONSTRAINT "FK_gameaccess_games_fk_Games" FOREIGN KEY ("fk_Games") REFERENCES "Global".games (id) ON DELETE CASCADE,
        CONSTRAINT "FK_gameaccess_users_fk_Users" FOREIGN KEY ("fk_Users") REFERENCES "Global".users (id) ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE INDEX "IX_gameaccess_fk_Games" ON "Global".gameaccess ("fk_Games");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE UNIQUE INDEX "IX_games_name" ON "Global".games (name);
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE INDEX "IX_games_ownerId" ON "Global".games ("ownerId");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE UNIQUE INDEX "IX_users_email" ON "Global".users (email);
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    CREATE UNIQUE INDEX "IX_users_name" ON "Global".users (name);
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20250323115916_InitialGDBMigration') THEN
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20250323115916_InitialGDBMigration', '9.0.3');
    END IF;
END $EF$;
COMMIT;